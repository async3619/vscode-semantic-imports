name: Publish

on:
  release:
    types: [published]

permissions:
  contents: read

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - run: pnpm install

      - name: Publish to Marketplace
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}
        run: |
          pnpm run build
          if [[ "${{ github.ref_name }}" == *-* ]]; then
            VERSION="${{ github.ref_name }}"
            VERSION="${VERSION#v}"
            BASE="${VERSION%%-*}"
            MAJOR=$(echo "$BASE" | cut -d. -f1)
            MINOR=$(echo "$BASE" | cut -d. -f2)
            DEV_NUM="${VERSION##*.}"
            if (( MINOR % 2 == 0 )); then MINOR=$((MINOR + 1)); fi
            npm version "$MAJOR.$MINOR.$DEV_NUM" --no-git-tag-version
            pnpm exec vsce package --no-dependencies --pre-release
            pnpm exec vsce publish --no-dependencies --packagePath *.vsix --pre-release
          else
            pnpm exec vsce package --no-dependencies
            pnpm exec vsce publish --no-dependencies --packagePath *.vsix
          fi
